<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Données - Présences</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-logo">ENSA Fès</div>
    <div class="navbar-nav"><a href="index.html">Accueil</a> <a href="gestion.html">Gestion</a></div>
  </nav>

  <main class="container">
    <h2>Données globales de présence</h2>
    <p>Cette page affiche la copie globale des données stockées dans <strong>donnees_global</strong>.</p>

    <div style="margin:12px 0; display:flex; gap:12px; align-items:center;">
      <label>Filière:
        <select id="filiereFilter">
          <option value="">Toutes</option>
        </select>
      </label>
      <label>Semaine:
        <select id="semaineFilter">
          <option value="">Toutes</option>
        </select>
      </label>
      <button id="refreshBtn" class="btn-secondary">Rafraîchir</button>
    </div>

    <table class="attendance-table" id="donneesTable">
      <thead><tr><th>Filière</th><th>Semaine</th><th>Num</th><th>Statut</th><th>Module</th><th>Enseignant</th></tr></thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
    function loadGlobalDonnees() {
      try {
        const raw = localStorage.getItem('donnees_global') || sessionStorage.getItem('donnees') || '{}';
        return JSON.parse(raw || '{}');
      } catch (e) { console.error(e); return { absences: {} }; }
    }

    function populateFilters(absences) {
      const filieres = new Set();
      const semaines = new Set();
      Object.keys(absences || {}).forEach(k => {
        const parts = k.split('_'); if (parts.length !== 3) return;
        filieres.add(parts[0]); semaines.add(parts[1]);
      });
      const filSel = document.getElementById('filiereFilter'); filSel.innerHTML = '<option value="">Toutes</option>';
      Array.from(filieres).sort().forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; filSel.appendChild(o); });
      const semSel = document.getElementById('semaineFilter'); semSel.innerHTML = '<option value="">Toutes</option>';
      Array.from(semaines).sort((a,b)=>a-b).forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; semSel.appendChild(o); });
    }

    function renderTable(absences) {
      const tbody = document.querySelector('#donneesTable tbody'); tbody.innerHTML = '';
      const fil = document.getElementById('filiereFilter').value;
      const sem = document.getElementById('semaineFilter').value;
      Object.keys(absences || {}).sort().forEach(k => {
        const parts = k.split('_'); if (parts.length !== 3) return;
        const [filiere, semaine, num] = parts;
        const raw = absences[k];
        const statut = (raw && typeof raw === 'string') ? raw : (raw && raw.statut ? raw.statut : '');
        let moduleName = (raw && raw.module) ? raw.module : '';
        let teacherName = (raw && raw.teacher) ? raw.teacher : '';
        if (!moduleName) moduleName = (function(){ const dflt = { isdia: 'Algèbre' }; return dflt[filiere] || 'Analyse'; })();
        if (!teacherName) teacherName = sessionStorage.getItem('current_user_display') || sessionStorage.getItem('current_user') || '';
        if ((fil && fil !== filiere) || (sem && sem !== semaine)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${filiere}</td><td>${semaine}</td><td>${num}</td><td>${statut}</td><td>${moduleName}</td><td>${teacherName}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const data = loadGlobalDonnees();
      populateFilters(data.absences);
      renderTable(data.absences);
      document.getElementById('refreshBtn').addEventListener('click', () => {
        const d = loadGlobalDonnees(); populateFilters(d.absences); renderTable(d.absences);
      });
      document.getElementById('filiereFilter').addEventListener('change', () => renderTable(loadGlobalDonnees().absences));
      document.getElementById('semaineFilter').addEventListener('change', () => renderTable(loadGlobalDonnees().absences));
      // Update live when donnees_global changes in other tabs
      window.addEventListener('storage', (e)=>{ if (e.key === 'donnees_global') { const d = loadGlobalDonnees(); populateFilters(d.absences); renderTable(d.absences); } });
    });
  </script>
</body>
</html>
